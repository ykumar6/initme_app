<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:a="http://ajax.org/2005/aml" >
    <head profile="http://www.w3.org/2005/10/profile">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

	 <script src="{static}/socket.io/socket.io.js"></script>
        <script  type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
        <script  type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.14/jquery-ui.min.js"></script>
        <script  type="text/javascript" src="{static}/scripts/layout.js"></script>
        <script  type="text/javascript" src="{static}/scripts/tabs.js"></script>
        <script  type="text/javascript" src="{static}/scripts/logger.js"></script>
        <script  type="text/javascript" src="{static}/scripts/projectManagement.js"></script>
        <script  type="text/javascript" src="{static}/scripts/facebook_oauth.js"></script>

        <link href='{static}/scripts/layout.css' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Lato:300,400,700' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="{static}/scripts/codemirror/lib/codemirror.css">
        <script src="{static}/scripts/codemirror/lib/codemirror.js"></script>
        <link rel="stylesheet" href="{static}/main.css">
        <script src="{static}/scripts/codemirror/mode/xml/xml.js"></script>
        <script src="{static}/scripts/codemirror/mode/php/php.js"></script>
        <script src="{static}/scripts/codemirror/mode/clike/clike.js"></script>
        <script src="{static}/scripts/codemirror/mode/javascript/javascript.js"></script>
        <script src="{static}/scripts/codemirror/mode/css/css.js"></script>
        <script src="{static}/scripts/async/lib/async.js"></script>
        <script src="{static}/scripts/inlineedit/jquery.inlineedit.js"></script>
<!-- begin olark code --><script type='text/javascript'>/*{literal}<![CDATA[*/window.olark||(function(i){var e=window,h=document,a=e.location.protocol=="https:"?"https:":"http:",g=i.name,b="load";(function(){e[g]=function(){(c.s=c.s||[]).push(arguments)};var c=e[g]._={},f=i.methods.length; while(f--){(function(j){e[g][j]=function(){e[g]("call",j,arguments)}})(i.methods[f])} c.l=i.loader;c.i=arguments.callee;c.f=setTimeout(function(){if(c.f){(new Image).src=a+"//"+c.l.replace(".js",".png")+"&"+escape(e.location.href)}c.f=null},20000);c.p={0:+new Date};c.P=function(j){c.p[j]=new Date-c.p[0]};function d(){c.P(b);e[g](b)}e.addEventListener?e.addEventListener(b,d,false):e.attachEvent("on"+b,d); (function(){function l(j){j="head";return["<",j,"></",j,"><",z,' onl'+'oad="var d=',B,";d.getElementsByTagName('head')[0].",y,"(d.",A,"('script')).",u,"='",a,"//",c.l,"'",'"',"></",z,">"].join("")}var z="body",s=h[z];if(!s){return setTimeout(arguments.callee,100)}c.P(1);var y="appendChild",A="createElement",u="src",r=h[A]("div"),G=r[y](h[A](g)),D=h[A]("iframe"),B="document",C="domain",q;r.style.display="none";s.insertBefore(r,s.firstChild).id=g;D.frameBorder="0";D.id=g+"-loader";if(/MSIE[ ]+6/.test(navigator.userAgent)){D.src="javascript:false"} D.allowTransparency="true";G[y](D);try{D.contentWindow[B].open()}catch(F){i[C]=h[C];q="javascript:var d="+B+".open();d.domain='"+h.domain+"';";D[u]=q+"void(0);"}try{var H=D.contentWindow[B];H.write(l());H.close()}catch(E){D[u]=q+'d.write("'+l().replace(/"/g,String.fromCharCode(92)+'"')+'");d.close();'}c.P(2)})()})()})({loader:(function(a){return "static.olark.com/jsclient/loader0.js?ts="+(a?a[1]:(+new Date))})(document.cookie.match(/olarkld=([0-9]+)/)),name:"olark",methods:["configure","extend","declare","identify"]});
/* custom configuration goes here (www.olark.com/documentation) */
olark.identify('5621-433-10-9060');/*]]>{/literal}*/</script>
<!-- end olark code -->
        <script type="text/javascript">
            io.util.uniqueUri = function(uri) {
                var protocol = uri.protocol, host = uri.host, port = uri.port;
                host = host || document.domain;
                port = port || (protocol == 'https' && document.location.protocol !== 'https:' ? 443 : document.location.port);

                return (protocol || 'http') + '://' + host + "/" + uri.directory;
            };

            document.projectId = "{projId}";
            document.appUrl = "{appUrl}";
            document.oauth = "{oauth}";
            document.isOwner = {isOwner};
            document.FacebookId = "{facebookId}";
            
            $(function() {

                var alertFallback = false;
                if( typeof console === "undefined" || typeof console.log === "undefined") {
                    console = {};
                    if(alertFallback) {
                        console.log = function(msg) {
                            alert(msg);
                        };
                    } else {
                        console.log = function() {
                        };
                    }
                }

                function IsIE8Browser() {
                    var rv = -1;
                    var ua = navigator.userAgent;
                    var re = new RegExp("Trident\/([0-9]{1,}[\.0-9]{0,})");
                    if(re.exec(ua) != null) {
                        rv = parseFloat(RegExp.$1);
                    }
                    return (rv == 4);
                };

                if(IsIE8Browser()) {
                    $("body").addClass("ie8");
                }
                $('body').layout({
                    north__resizable : false,
                    north__closable : false,
                    north__spacing_open : 0,
                    north__spacing_closed : 0,
                    north__slidable : false,
                    east__size : "50%",
                    east__closable : false,
                });

                $(".ui-layout-center").layout({
                    north__resizable : false,
                    north__closable : false,
                    north__spacing_open : 0,
                    north__spacing_closed : 0,
                    north__slidable : false,
                    north__paneSelector : ".codearea-north",
                    center__paneSelector : ".codearea-center",
                    center__onresize : function() {
                        document.CodeCommands.refresh("main");
                    }
                })

                $(".ui-layout-east").layout({
                    north__resizable : false,
                    north__closable : false,
                    center__paneSelector : ".server-center",
                    center__onresize : function() {
                        document.CodeCommands.refresh("secondary");
                    },
                    south__paneSelector : ".server-south",
                    south__size : "50%",
                    south__closable : false,
                    north__spacing_open : 0,
                    north__spacing_closed : 0,
                    north__slidable : false,
                })

                $(".codearea-center").layout({
                    center__paneSelector : ".code-center",
                })

                var southPane = $(".server-south").layout({
                    center__paneSelector : ".browser-center",
                    south__paneSelector : ".browser-south",
                    center__onresize : function() {
                        positionLoading();
                    },
                    south__resizable : false,
                    south__closable : false,
                    south__spacing_open : 0,
                    south__spacing_closed : 0,
                    south__slidable : false

                });

                var positionLoading = function() {
                    setTimeout(function() {
                        $(".loading").position({
                            of : $(".browser-center"),
                            my : "center center",
                            at : "center center"
                        });
                        $(".facebook_oauth").position({
                            of : $(".browser-center"),
                            my : "center center",
                            at : "center center"
                        });
                    }, 10);
                    
                };
                positionLoading();
                
                document.CodeCommands = CodeModule($(".editor")); //load up editor
                var oauthSession, projectSession;
                document.logHandler = new Logger(southPane);

                
                projectSession = new document.ProjectManagement();
                if (document.oauth === "facebook") {
                    projectSession.setState("oauth");

                    oauthSession = new document.FacebookOAuth();
                    $("body").bind("oauthLogin", function(e, token) {
			   window.accessToken = token;
                        projectSession.setState("active");
                    });
                    $("body").bind("oauthLogout", function(e) {
			   $("#appFrame").attr("src", "http://" + document.domain + "/loading");
                        projectSession.setState("oauth");
                    });
                } 
		  else {
		      $(".tag.facebook").hide();
			projectSession.setState("active");
		  }
                projectSession.loadProject();

                
                $("body").bind("vmConnected", function(e) {
                    projectSession.setState("vmActive");
                });
                $("body").bind("vmDisconnected", function(e) {
		      $("#appFrame").attr("src", "http://" + document.domain + "/loading");
                    projectSession.setState("vmInactive");
                });
                

                
                var _save = function() {
                    document.CodeCommands.save(function() {
                        $.ajax({
                            type : "GET",
                            url : "http://" + document.domain + "/save/" + document.projectId + "?ts=" + (new Date()).getTime(),
                            success : function(data) {
                                $(".title h1").html(data.projectTitle);
                                $(".subTitle h2").html(data.subTitle);

                                $(".title h1").inlineEdit({
                                    save : function(e, data) {
                                        $.post("http://" + document.domain + "/title/" + document.projectId, data);
                                        return true;
                                    }
                                });
                                $(".title h1").addClass("owner");

                    		    $(".subTitle h2").addClass("owner");
                    		    $(".subTitle h2").inlineEdit({
                        		save : function(e, data) {
                            		$.post("http://" + document.domain + "/subTitle/" + document.projectId, data);
                            		return true;
                        		}
                    		    });
                                if(window.history && window.history.pushState) {
                                    window.history.pushState({}, "", "http://" + document.domain + "/" + document.projectId);
                                } else {
                                    window.location = "http://" + document.domain + "/" + document.projectId;
                                }
                            },
                            error : function(err) {
                                console.log(err);
                                window.location = "/?state=loginEditor";
                            }
                        });
                    });
                }

                $(".btn.fork").mouseup(function() {
                    if(!$(".btn.fork").hasClass("disabled")) {
                        document.logHandler.clear();
                        if(!document.isOwner) {
                            projectSession.createProject(_save);
                        } else if(document.isOwner && document.URL.indexOf(document.projectId) < 0) {
                            _save();
                        } else {
                            document.CodeCommands.save();
                        }
                    }
                });

                $(".btn.run").click(function() {
                    if (!projectSession.isActive) return;
                    
                    document.logHandler.clear();
                    if(document.isOwner) {
                        document.CodeCommands.push();
                    } else {
                        projectSession.createProject(function() {
                            document.CodeCommands.push();
                        });
                    }
                });

                $(".button.reset").mouseup(function() {
                    if(!$(".button.reset").hasClass("disabled")) {
                        document.CodeCommands.reset();
                        $(".button.reset").addClass("disabled");
                        if($(".button.save").hasClass("disabled")) {
                            $(".button.save").removeClass("disabled");
                        }
                    }
                });

                $("body").bind("save", function(e, state) {
                    if(!$(".btn.fork").hasClass("disabled")) {
                        $(".btn.fork").addClass("disabled");
                    }
                });
                $("body").bind("push", function(e, state) {
                    if(!$(".btn.fork").hasClass("disabled") && document.URL.indexOf(document.projectId) >= 0) {
                        $(".btn.fork").addClass("disabled");
                    }
                    var iframe = document.getElementById("appFrame");
                    iframe.src = iframe.src;
                });


                $("a.LOGOUT").mouseup(function() {
                    window.location = "/logout?redirect=" + window.location;
                });

                $("a.LOGIN").mouseup(function() {
                    window.location = "/?state=loginEditor&redirect=" + window.location;
                });

                $(".btn.newCode").mouseup(function() {
                    window.location = "/?state=newCode";
                });

                $(".btn.discoverCode").mouseup(function() {
                    window.location = "/?state=discoverCode";
                });

                $(".btn.download").mouseup(function() {
                    window.location = "/?state=downloadCode";
                });


                $(".btn.share").click(function(e) {
                    $("#sourceUrl").val("http://" + document.domain + "/" + document.projectId);
                    $("#appUrl").val("http://" + document.appUrl);
                    $(".shareDialog").css("top", "0px");
                    $(".shareDialog").css("left", "0px");
                    $(".shareDialog").position({
                        of : $(".btn.share"),
                        offset : "5 5",

                        my : "right top",
                        at : "right bottom"
                    });
                    $(".shareDialog").show();
                });

                $(".headerWrapper").click(function(e) {
                    if(!$(e.target).hasClass("share"))
                        e.target = $(e.target).parents(".btn.share");

                    if(!$(e.target).hasClass("share")) {
                        $(".shareDialog").hide();
                    }
                });

                $(".projAreaWrapper").click(function(e) {
                    if(!$(e.target).hasClass("share"))
                        e.target = $(e.target).parents(".btn.share");

                    if(!$(e.target).hasClass("share")) {
                        $(".shareDialog").hide();
                    }
                });

                if(document.isOwner) {
                    $(".title h1").addClass("owner");
                    $(".title h1").inlineEdit({
                        save : function(e, data) {
                            $.post("http://" + document.domain + "/title/" + document.projectId, data);
                            return true;
                        }
                    });
                    $(".subTitle h2").addClass("owner");
                    $(".subTitle h2").inlineEdit({
                        save : function(e, data) {
                            $.post("http://" + document.domain + "/subTitle/" + document.projectId, data);
                            return true;
                        }
                    });
                }

            });

        </script>
    </head>
    <body>
        <div class="ui-layout-center">
            <div class="codearea-center">
                <div class="code-center">
                    <div class="editor html active" fileName="main.php">
                        <textarea class="code" mode="application/x-httpd-php" name="main.php">
{main.php}
</textarea>
                    </div>
                    <div class="floatBar">
                        <div class="floatTab active">
                            PHP
                        </div>
                    </div>          
                    </div>
                    
                </div>
         </div>
                    <div class="ui-layout-north">
			   <div class="headerWrapper">
                        <div class="header">
                            <div class="logo"></div>
				<div class="headerOptions">
					<div class="btn newCode">
						<div class="caption">
							New Code
						</div>
						<div class="subText">
							Build & share code
						</div>
					</div>
					<div class="btn discoverCode">
						<div class="caption">
							Discover
						</div>
						<div class="subText">
							Code snippets & apps
						</div>
					</div>
				</div>
                            <div class="toolbar rightBar">
					<a href="/?state=Blog">BLOG</a>
					<a href="/?state=loginDirect">SIGN UP</a>
					<a class="{login}" href="javascript:void(0)">{login}</a>

                            </div>
                        </div>
			   </div>	
			   <div class="projAreaWrapper">
                        <div class="projArea">
				<div class="projLeft"> 
					<div class="info">
						<div class="title">
							<h1>{title}</h1>
							<div class="tags">
								<div class="tag facebook"><h3>facebook</h3></div>
								<div class="tag php"><h3>php</h3></div>
							</div>
						</div>
						<div class="subTitle">
						<h2>{subTitle}</h2>
						</div>
					</div>
					<div class="author">
						<img src="/images/ykumar6.jpg"/>
						<div class="text">{authorName}</div>
					</div>
				</div>
				<div class="projRight">
					<div class="commandBar">
						<div class="btn download">
							<div class="img"></div>
							<div class="caption">Download</div>
						</div>
						<div class="btn share">
							<div class="img"></div>
							<div class="caption">Share</div>
							<div class="dropdown"></div>

						</div>
						<div class="btn fork disabled">
							<div class="img"></div>
							<div class="caption">Save</div>
						</div>
					</div>
				</div>
                        </div>
			   </div>
                    </div>
   <div class="ui-layout-east">
                        <div class="server-center">
                            <div class="editor css active" fileName="css.php">
                                <textarea class="code" mode="css" name="css.php">
{css.php}
</textarea>
                    </div>
                            <div class="editor javascript" fileName="javascript.php">
                                <textarea class="code" mode="javascript"  name="javascript.php">
{javascript.php}
</textarea>
                    </div>
                    <div class="floatBar">
                        <div class="floatTab javascript">
                            Javascript
                        </div>
                        <div class="floatTab active css">
                            CSS
                        </div>
                    </div>
                    </div>
                    <div class="server-south">
                        <div class="browser-center">
				<div class="btn run">
					<div class="img"></div>
					<div class="text">Reload</div>
				</div>
                    		<div class="floatBar">
                       		   <div class="floatTab active">
                            		Output
                                </div>
                            </div>
				
                            <iframe id="appFrame" width="100%" height="100%" src="/loading" frameBorder="0">
                            </iframe>
                   		</div>
                        <div class="browser-south">
                            <div class="logBar">
                                <div class="icon check"></div>
                                <div class="logText">
                                    Your server is running at
                                </div>
                                <div class="logTime">
                                    2 minutes ago
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
				<div class="loading">
				</div>
				<div class="facebook_oauth">
				</div>
			<div class="shareDialog" style="display:none;">
				<div class="field source">
					<div class="text">Share your source code</div>
					<input id="sourceUrl" />
				</div>
				<div class="field app">
					<div class="text">Share your app</div>
					<input id="appUrl" />
				</div>
			</div>
			<div id="fb-root"></div> 
                    </body>
                    </html> 
