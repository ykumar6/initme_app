<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:a="http://ajax.org/2005/aml" >
    <head profile="http://www.w3.org/2005/10/profile">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

	 <script src="{static}/socket.io/socket.io.js"></script>
        <script  type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
        <script  type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.14/jquery-ui.min.js"></script>
        <script  type="text/javascript" src="{static}/scripts/layout.js"></script>
        <script  type="text/javascript" src="{static}/scripts/tabs.js"></script>
        <script  type="text/javascript" src="{static}/scripts/logger.js"></script>
        <script  type="text/javascript" src="{static}/scripts/projectManagement.js"></script>
        <script  type="text/javascript" src="{static}/scripts/facebook_oauth.js"></script>
        <script  type="text/javascript" src="{static}/scripts/TwilioChallenge.js"></script>


        <link href='{static}/scripts/layout.css' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Lato:300,400,700' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="{static}/scripts/codemirror/lib/codemirror.css">
        <script src="{static}/scripts/codemirror/lib/codemirror.js"></script>
        <link rel="stylesheet" href="{static}/main.css">
        <script src="{static}/scripts/codemirror/mode/xml/xml.js"></script>
        <script src="{static}/scripts/codemirror/mode/php/php.js"></script>
        <script src="{static}/scripts/codemirror/mode/clike/clike.js"></script>
        <script src="{static}/scripts/codemirror/mode/javascript/javascript.js"></script>
        <script src="{static}/scripts/codemirror/mode/css/css.js"></script>
        <script src="{static}/scripts/async/lib/async.js"></script>
        <script src="{static}/scripts/inlineedit/jquery.inlineedit.js"></script>
        <script type="text/javascript">
            io.util.uniqueUri = function(uri) {
                var protocol = uri.protocol, host = uri.host, port = uri.port;
                host = host || document.domain;
                port = port || (protocol == 'https' && document.location.protocol !== 'https:' ? 443 : document.location.port);

                return (protocol || 'http') + '://' + host + "/" + uri.directory;
            };

            document.projectId = "{projId}";
            document.appUrl = "{appUrl}";
            document.tags = "{tags}";
            document.isOwner = {isOwner};
            document.FacebookId = "{facebookId}";
            
            $(function() {

		  document.tags = (document.tags || "").split(",");
		  var tagStr = "";
		  for (var i=0; i<document.tags.length; i++) {
			tagStr += '<div class="tag ' + document.tags[i] + '"><h3>' + document.tags[i] + '</h3></div>';
		  }
		  $(".tags").append(tagStr);
		  
                var alertFallback = false;
                if( typeof console === "undefined" || typeof console.log === "undefined") {
                    console = {};
                    if(alertFallback) {
                        console.log = function(msg) {
                            alert(msg);
                        };
                    } else {
                        console.log = function() {
                        };
                    }
                }

                function IsIE8Browser() {
                    var rv = -1;
                    var ua = navigator.userAgent;
                    var re = new RegExp("Trident\/([0-9]{1,}[\.0-9]{0,})");
                    if(re.exec(ua) != null) {
                        rv = parseFloat(RegExp.$1);
                    }
                    return (rv == 4);
                };

                if(IsIE8Browser()) {
                    $("body").addClass("ie8");
                }
                $('body').layout({
                    north__resizable : false,
                    north__closable : false,
                    north__spacing_open : 0,
                    north__spacing_closed : 0,
                    north__slidable : false,
                    east__size : "50%",
                    east__closable : false,
                });

                $(".ui-layout-center").layout({
                    north__resizable : false,
                    north__closable : false,
                    north__spacing_open : 0,
                    north__spacing_closed : 0,
                    north__slidable : false,
                    north__paneSelector : ".codearea-north",
                    center__paneSelector : ".codearea-center",
                    center__onresize : function() {
                        document.CodeCommands.refresh("main");
                    }
                })

                $(".ui-layout-east").layout({
                    north__resizable : false,
                    north__closable : false,
                    center__paneSelector : ".server-center",
                    center__onresize : function() {
                        document.CodeCommands.refresh("secondary");
                    },
                    south__paneSelector : ".server-south",
                    south__size : "50%",
                    south__closable : false,
                    north__spacing_open : 0,
                    north__spacing_closed : 0,
                    north__slidable : false,
                })

                $(".codearea-center").layout({
                    center__paneSelector : ".code-center"
                })

                var southPane = $(".server-south").layout({
                    center__paneSelector : ".browser-center",
                    south__paneSelector : ".browser-south",
                    center__onresize : function() {
			   if ($("body").hasClass("oauth") || $("body").hasClass("inactive")) {
                        	positionLoading();
			   }
			   logBar.resizeAll();
                    },
                    south__resizable : false,
                    south__closable : false,
                    south__spacing_open : 0,
                    south__spacing_closed : 0,
                    south__slidable : false

                });

                $(".browser-center").layout({
                    north__paneSelector : ".browserToolbar",
                    north__resizable : false,
                    north__closable : false,
                    center__paneSelector : ".browserWindow",
                    north__spacing_open : 0,
                    north__spacing_closed : 0,
                    north__slidable : false,
                })

                var logBar = $(".logBar").layout({
                    east__paneSelector : ".logTime",
                    east__resizable : false,
                    east__closable : false,
                    east__size : 100,
                    center__paneSelector : ".logText",
                    east__spacing_open : 0,
                    east__spacing_closed : 0,
                    east__slidable : false,
                    west__paneSelector : ".logIcon",
                    west__resizable : false,
                    west__closable : false,
                    west__spacing_open : 0,
                    west__spacing_closed : 0,
                    west__slidable : false,
                    west__size : 40
                })


                var positionLoading = function() {
                    setTimeout(function() {
                        $(".loading").position({
                            of : $(".browser-center"),
                            my : "center center",
                            at : "center center"
                        });
                        $(".challenge").position({
                            of : $(".browser-center"),
                            my : "center center",
                            at : "center center"
                        });
                    }, 10);
                    
                };
                positionLoading();
                
                document.CodeCommands = CodeModule($(".editor")); //load up editor
                var challengeSession, projectSession;
                document.logHandler = new Logger(southPane);

                
                projectSession = new document.ProjectManagement();
                if ($.inArray("facebook", document.tags) >= 0 ) {
                    projectSession.setState("oauth");
                    positionLoading();


                    challengeSession = new document.FacebookOAuth();
                    $("body").bind("oauthLogin", function(e, token) {
			   window.accessToken = token;
                        projectSession.setState("active");
                    });
                    $("body").bind("oauthLogout", function(e) {
			   $("#appFrame").attr("src", "http://" + document.domain + "/loading");
                        projectSession.setState("oauth");
                        positionLoading();

                    });
                } 
                if ($.inArray("twilio", document.tags) >= 0 ) {
                    projectSession.setState("oauth");
                    positionLoading();


                    challengeSession = new document.TwilioChallenge(projectSession);
                    $("body").bind("challengeComplete", function(e, token) {
                        projectSession.setState("active");
                    });
                    $("body").bind("challengeStart", function(e) {
			   $("#appFrame").attr("src", "http://" + document.domain + "/loading");
                        projectSession.setState("oauth");
                        positionLoading();

                    });
                } 
		  else {
			projectSession.setState("active");
		  }
                projectSession.loadProject();

                
                $("body").bind("vmConnected", function(e) {
                    projectSession.setState("vmActive");
                });
                $("body").bind("vmDisconnected", function(e) {
		      $("#appFrame").attr("src", "http://" + document.domain + "/loading");
                    projectSession.setState("vmInactive");
		      positionLoading();
                });
                

                
                var _save = function() {
                    document.CodeCommands.save(function() {
                        $.ajax({
                            type : "GET",
                            url : "http://" + document.domain + "/save/" + document.projectId + "?ts=" + (new Date()).getTime(),
                            success : function(data) {
                                $(".title h1").html(data.projectTitle);
                                $(".subTitle h2").html(data.subTitle);

                                $(".title h1").inlineEdit({
                                    save : function(e, data) {
                                        $.post("http://" + document.domain + "/title/" + document.projectId, data);
                                        return true;
                                    }
                                });
                                $(".title h1").addClass("owner");

                    		    $(".subTitle h2").addClass("owner");
                    		    $(".subTitle h2").inlineEdit({
                        		save : function(e, data) {
                            		$.post("http://" + document.domain + "/subTitle/" + document.projectId, data);
                            		return true;
                        		}
                    		    });
                                if(window.history && window.history.pushState) {
                                    window.history.pushState({}, "", "http://" + document.domain + "/" + document.projectId);
                                } else {
                                    window.location = "http://" + document.domain + "/" + document.projectId;
                                }
                            },
                            error : function(err) {
                                console.log(err);
                                window.location = "/?state=loginEditor";
                            }
                        });
                    });
                }

                $(".btn.fork").mouseup(function() {
                    if(!$(".btn.fork").hasClass("disabled")) {
                        document.logHandler.clear();
                        if(!document.isOwner) {
                            projectSession.createProject(_save);
                        } else if(document.isOwner && document.URL.indexOf(document.projectId) < 0) {
                            _save();
                        } else {
                            document.CodeCommands.save();
                        }
                    }
                });

                $(".btn.run").click(function() {
                    if (!projectSession.isActive) return;
                    
                    document.logHandler.clear();
                    if(document.isOwner) {
                        document.CodeCommands.push();
                    } else {
                        projectSession.createProject(function() {
                            document.CodeCommands.push();
                        });
                    }
                });

                $(".button.reset").mouseup(function() {
                    if(!$(".button.reset").hasClass("disabled")) {
                        document.CodeCommands.reset();
                        $(".button.reset").addClass("disabled");
                        if($(".button.save").hasClass("disabled")) {
                            $(".button.save").removeClass("disabled");
                        }
                    }
                });

                $("body").bind("save", function(e, state) {
                    if(!$(".btn.fork").hasClass("disabled")) {
                        $(".btn.fork").addClass("disabled");
                    }
                });
                $("body").bind("push", function(e, state) {
                    if(!$(".btn.fork").hasClass("disabled") && document.URL.indexOf(document.projectId) >= 0) {
                        $(".btn.fork").addClass("disabled");
                    }
                    var iframe = document.getElementById("appFrame");
                    iframe.src = iframe.src;
                });


                $("a.LOGOUT").mouseup(function() {
                    window.location = "/logout?redirect=" + window.location;
                });

                $("a.LOGIN").mouseup(function() {
                    window.location = "/?state=loginEditor&redirect=" + window.location;
                });

                $(".btn.newCode").mouseup(function() {
                    window.location = "/?state=newCode";
                });

                $(".btn.discoverCode").mouseup(function() {
                    window.location = "/?state=discoverCode";
                });

                $(".btn.download").mouseup(function() {
                    window.location = "/?state=downloadCode";
                });


                $(".btn.share").click(function(e) {
                    $("#sourceUrl").val("http://" + document.domain + "/" + document.projectId);
                    $("#appUrl").val("http://" + document.appUrl);
                    $(".shareDialog").css("top", "0px");
                    $(".shareDialog").css("left", "0px");
                    $(".shareDialog").position({
                        of : $(".btn.share"),
                        offset : "5 5",

                        my : "right top",
                        at : "right bottom"
                    });
                    $(".shareDialog").show();
                });

                $(".headerWrapper").click(function(e) {
                    if(!$(e.target).hasClass("share"))
                        e.target = $(e.target).parents(".btn.share");

                    if(!$(e.target).hasClass("share")) {
                        $(".shareDialog").hide();
                    }
                });

                $(".projAreaWrapper").click(function(e) {
                    if(!$(e.target).hasClass("share"))
                        e.target = $(e.target).parents(".btn.share");

                    if(!$(e.target).hasClass("share")) {
                        $(".shareDialog").hide();
                    }
                });

                if(document.isOwner) {
                    $(".title h1").addClass("owner");
                    $(".title h1").inlineEdit({
                        save : function(e, data) {
                            $.post("http://" + document.domain + "/title/" + document.projectId, data);
                            return true;
                        }
                    });
                    $(".subTitle h2").addClass("owner");
                    $(".subTitle h2").inlineEdit({
                        save : function(e, data) {
                            $.post("http://" + document.domain + "/subTitle/" + document.projectId, data);
                            return true;
                        }
                    });
                }

            });

        </script>
    </head>
    <body>
        <div class="ui-layout-center">
            <div class="codearea-center">
                <div class="code-center">
                    <div class="editor html active" fileName="main.php">
                        <textarea class="code" mode="application/x-httpd-php" name="main.php">
{main.php}
</textarea>
                    </div>
                    <div class="floatBar">
                        <div class="floatTab active">
                            PHP
                        </div>
                    </div>          
                    </div>
                </div>
         </div>
                    <div class="ui-layout-north">
			   <div class="headerWrapper">
                        <div class="header">
                            <div class="logo"></div>
				<div class="headerOptions">
					<div class="btn newCode">
						<div class="caption">
							New Code
						</div>
						<div class="subText">
							Build & share code
						</div>
					</div>
					<div class="btn discoverCode">
						<div class="caption">
							Discover
						</div>
						<div class="subText">
							Code snippets & apps
						</div>
					</div>
				</div>
                            <div class="toolbar rightBar">
					<a href="/?state=Blog">BLOG</a>
					<a href="/?state=loginDirect">SIGN UP</a>
					<a class="{login}" href="javascript:void(0)">{login}</a>

                            </div>
                        </div>
			   </div>	
			   <div class="projAreaWrapper">
                        <div class="projArea">
				<div class="projLeft"> 
					<div class="info">
						<div class="title">
							<h1>{title}</h1>
							<div class="tags">

							</div>
						</div>
						<div class="subTitle">
						<h2>{subTitle}</h2>
						</div>
					</div>
					<div class="author">
						<img src="/images/ykumar6.jpg"/>
						<div class="text">{authorName}</div>
					</div>
				</div>
				<div class="projRight">
					<div class="commandBar">
						<div class="btn download">
							<div class="img"></div>
							<div class="caption">Download</div>
						</div>
						<div class="btn share">
							<div class="img"></div>
							<div class="caption">Share</div>
							<div class="dropdown"></div>

						</div>
						<div class="btn fork disabled">
							<div class="img"></div>
							<div class="caption">Save</div>
						</div>
					</div>
				</div>
                        </div>
			   </div>
                    </div>
   <div class="ui-layout-east">
                        <div class="server-center">
                            <div class="editor css" fileName="css.php">
                                <textarea class="code" mode="css" name="css.php">
{css.php}
</textarea>
                    </div>
                            <div class="editor active additional" fileName="additional.php">
                                <textarea class="code" mode="{additionalMode}"  name="additional.php">
{additional.php}
</textarea>
                    </div>
                    <div class="floatBar">
                        <div class="floatTab active additional">
                            {additionalName}
                        </div>
                        <div class="floatTab css">
                            CSS
                        </div>
                    </div>
                    </div>
                    <div class="server-south">
                        <div class="browser-center">
				<div class="browserToolbar">
				<div class="btn run">
					<div class="img"></div>
					<div class="text">Reload</div>
				</div>
				<div class="saveStatus">Unsaved Changes... Click reload to save</div>
                    		<div class="floatBar">
                       		   <div class="floatTab active">
                            		Output
                                </div>
                            </div>
				</div>
				
				<div class="browserWindow">
                            <iframe id="appFrame" width="100%" height="100%" src="/loading" frameBorder="0">
                            </iframe>
				</div>
                   		</div>
                        <div class="browser-south">
                            <div class="logBar">
                                <div class="icon check logIcon"></div>
                                <div class="logText">
					<div class="logTextInner">
                                    Your server is running at
					</div>
                                </div>
                                <div class="logTime">
                                    2 minutes ago
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
				<div class="loading">
				</div>
				<div class="challenge {challengeClass}">
					<div class="twilioVerify">
						<div class="logo">
						</div>
						<div class="box">
							Please verify your phone number to run this code snippet
							<div class="phoneBox">
							<div class="code">+1</div><input type="text" value="" /> <div class="button">Call</div>
							</div>
						</div>
						<div class="verifyCode">
							Please enter this number
							<div class="codeBox">
							<div class="verifyCodeNumber">12324242</div> <div class="button">Done</div>
							</div>
						</div>
					</div>
				</div>
			<div class="shareDialog" style="display:none;">
				<div class="field source">
					<div class="text">Share your source code</div>
					<input id="sourceUrl" />
				</div>
				<div class="field app">
					<div class="text">Share your app</div>
					<input id="appUrl" />
				</div>
			</div>
			<div id="fb-root"></div> 
                    </body>
                    </html> 
